name: Generate Comparison Table

on:
  push:
    branches:
      - main
    paths:
      - "platforms.json"
      - "generate_table.py"
  workflow_dispatch:  # allows manual trigger from GitHub Actions UI

permissions:
  contents: write

jobs:
  generate-table:
    name: Regenerate COMPARISON.md
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Validate platforms.json
        run: |
          python - <<'EOF'
          import json, sys

          try:
              with open("platforms.json", "r", encoding="utf-8") as f:
                  data = json.load(f)
          except json.JSONDecodeError as e:
              print(f"❌ platforms.json is not valid JSON: {e}")
              sys.exit(1)

          required_top_keys = {"features", "categories", "platforms"}
          missing = required_top_keys - data.keys()
          if missing:
              print(f"❌ platforms.json is missing required top-level keys: {missing}")
              sys.exit(1)

          feature_keys = {f["key"] for f in data["features"]}
          errors = []

          for platform in data["platforms"]:
              pid = platform.get("id", "unknown")

              for field in ["id", "name", "url", "category", "features"]:
                  if field not in platform:
                      errors.append(f"Platform '{pid}' missing required field: '{field}'")

              if platform.get("category") not in data["categories"]:
                  errors.append(
                      f"Platform '{pid}' has unknown category: '{platform.get('category')}'. "
                      f"Valid categories: {data['categories']}"
                  )

              valid_values = {"yes", "no", "partial", "planned", "unknown"}
              for fkey, fval in platform.get("features", {}).items():
                  if fkey not in feature_keys:
                      errors.append(f"Platform '{pid}' has unknown feature key: '{fkey}'")
                  if fval.lower() not in valid_values:
                      errors.append(
                          f"Platform '{pid}', feature '{fkey}' has invalid value: '{fval}'. "
                          f"Valid values: {valid_values}"
                      )

          if errors:
              print("❌ Validation failed:\n")
              for e in errors:
                  print(f"  • {e}")
              sys.exit(1)

          print(f"✅ platforms.json valid — "
                f"{len(data['platforms'])} platforms, "
                f"{len(data['features'])} features.")
          EOF

      - name: Generate COMPARISON.md
        run: python generate_table.py

      - name: Commit and push COMPARISON.md
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Stage COMPARISON.md whether it's new or modified
          git add COMPARISON.md

          # Only commit if there is actually something staged
          if git diff --cached --quiet; then
            echo "ℹ️ COMPARISON.md is already up to date — nothing to commit."
          else
            git commit -m "chore: regenerate COMPARISON.md from platforms.json [skip ci]"
            git push
            echo "✅ COMPARISON.md updated and pushed."
          fi
